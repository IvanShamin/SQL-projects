/* Ceramic Frit Database: Phase 1 - Exploration and Chemical Profiling
  Author: [Your Name]
  Description: Analyzing frit compositions to identify primary oxide carriers 
               and audit data integrity.
*/

-- 1. Database Inspection
USE frity;
SHOW TABLES; -- Tables: frity (frit metadata), oxidy (oxide list), slozeni (compositions)

-- 2. Master Data View
-- Merging metadata, composition, and chemical formulas for a complete profile.
with v_frit_compositions as(
SELECT 
    f.nazev AS frit_name, 
    o.chemvzorec AS formula,
    s.mnozstvi AS amount
FROM frity f 
JOIN slozeni s ON f.id = s.id_pol 
JOIN oxidy o ON s.id_sur = o.id)
select * from v_frit_compositions;


-- 3. Data Quality Audit
-- Flagging frits that do not sum to exactly 100% (Vital for chemical accuracy).
SELECT 
    frit_name, 
    ROUND(SUM(amount), 1) AS total_amount
FROM v_frit_compositions
GROUP BY frit_name
HAVING total_amount <> 100.0;

-- 4. Material Potency Ranking (Window Functions)
-- Ranking frits by their concentration of specific oxides.
-- This identifies which materials are the most efficient 'carriers' for a target chemistry.
WITH OxideRanking AS (
    SELECT 
        frit_name, 
        formula,
        amount,
        DENSE_RANK() OVER(PARTITION BY formula ORDER BY amount DESC) as oxide_rank
    FROM v_frit_compositions
)
-- Selecting Top 5 'Carriers' for each oxide in the database
SELECT * FROM OxideRanking
WHERE oxide_rank <= 5
ORDER BY formula, oxide_rank;


/* STEP 1: DATA INTEGRITY AUDIT
  Ceramic calculations require recipes to sum to 100%. 
  This script flags records that require manual correction.
*/

-- Audit 1: Percentage Summation Check
-- Identifies frits where the sum of oxides is not exactly 100.0%.
SELECT 
    f.nazev AS frit_name,
    ROUND(SUM(s.mnozstvi), 1) AS total_percentage
FROM frity f 
JOIN slozeni s ON f.id = s.id_pol 
GROUP BY f.nazev
HAVING total_percentage <> 100.0;

-- Audit 2: Granular Composition Overview
-- Uses Window Functions to compare individual oxide amounts against the total sum.
SELECT 
    f.nazev AS frit_name, 
    o.chemvzorec AS formula,
    s.mnozstvi AS amount,
    COUNT(s.mnozstvi) OVER(PARTITION BY f.nazev) AS oxide_count,
    SUM(s.mnozstvi) OVER(PARTITION BY f.nazev) AS sum_check
FROM frity f 
JOIN slozeni s ON f.id = s.id_pol 
JOIN oxidy o ON s.id_sur = o.id
ORDER BY oxide_count DESC, frit_name;

/* STEP 2: INVENTORY & CHEMICAL PROFILING
  Analyzing the complexity of frits and the distribution of oxides.
*/

-- Report 1: The "Complexity & Variety" Audit
-- Categorizes frits by the number of oxides provided (Simple vs. Complex).
SELECT 
    f.nazev AS frit_name,
    COUNT(s.id_sur) AS oxide_count,
    GROUP_CONCAT(o.chemvzorec SEPARATOR ', ') AS oxide_list
FROM frity f
JOIN slozeni s ON f.id = s.id_pol
JOIN oxidy o ON s.id_sur = o.id
GROUP BY f.nazev
ORDER BY oxide_count DESC;

-- Report 2: Global Oxide Distribution (The "Staples" Report)
-- Identifies the most frequently used oxides and their concentration ranges.
SELECT 
    o.chemvzorec AS formula,
    COUNT(f.id) AS appearance_count,
    ROUND(AVG(s.mnozstvi), 2) AS avg_concentration,
    MAX(s.mnozstvi) AS max_concentration,
    MIN(s.mnozstvi) AS min_concentration
FROM oxidy o
JOIN slozeni s ON o.id = s.id_sur
JOIN frity f ON s.id_pol = f.id
GROUP BY o.id, o.chemvzorec
ORDER BY appearance_count DESC;

/* PROJECT: Ceramic Frit Material Informatics
  PHASE 1: Chemical Profiling & Data Integrity Audit
  AUTHOR: [Your Name]
  
  DESCRIPTION: 
    This script establishes a master view for frit chemistry and performs 
    critical data health checks. It identifies 'Signature Oxides' through 
    potency ranking using SQL Window Functions.
*/

-- ---------------------------------------------------------
-- 1. ENVIRONMENT SETUP
-- ---------------------------------------------------------
USE frity;

-- ---------------------------------------------------------
-- 2. DATA ARCHITECTURE: THE MASTER VIEW
-- ---------------------------------------------------------
-- Creating a centralized view to simplify all downstream analytics.
CREATE OR REPLACE VIEW v_frit_compositions AS
SELECT 
    f.nazev AS frit_name, 
    o.chemvzorec AS formula,
    s.mnozstvi AS amount
FROM frity f 
JOIN slozeni s ON f.id = s.id_pol 
JOIN oxidy o ON s.id_sur = o.id;

-- ---------------------------------------------------------
-- 3. DATA QUALITY AUDIT
-- ---------------------------------------------------------
-- CERAMIC GOAL: Flag recipes that do not sum to 100%. 
-- Precise stoichiometry is required for molar calculations.
SELECT 
    frit_name, 
    ROUND(SUM(amount), 1) AS total_amount,
    ABS(100 - SUM(amount)) AS variance
FROM v_frit_compositions
GROUP BY frit_name
HAVING total_amount <> 100.0
ORDER BY variance DESC;

-- ---------------------------------------------------------
-- 4. ANALYTICS: POTENCY & CARRIER RANKING
-- ---------------------------------------------------------
-- CERAMIC GOAL: Identify the 'Top 5 Carriers' for each oxide.
-- This helps the engineer find the most concentrated source for a chemical.
WITH OxideRanking AS (
    SELECT 
        frit_name, 
        formula,
        amount,
        -- Using DENSE_RANK to handle ties in concentration percentages
        DENSE_RANK() OVER(PARTITION BY formula ORDER BY amount DESC) as oxide_rank
    FROM v_frit_compositions
)
SELECT * FROM OxideRanking
WHERE oxide_rank <= 5
ORDER BY formula, oxide_rank;

-- ---------------------------------------------------------
-- 5. BENCHMARKING: POTENCY RATIO (PHASE 1.5)
-- ---------------------------------------------------------
-- CERAMIC GOAL: Benchmarking specific frits against database averages.
WITH GlobalAverages AS (
    SELECT formula, AVG(amount) as avg_db_amount
    FROM v_frit_compositions
    GROUP BY formula
)
SELECT 
    v.frit_name,
    v.formula,
    v.amount AS local_concentration,
    ROUND(v.amount / g.avg_db_amount, 2) AS potency_ratio
FROM v_frit_compositions v
JOIN GlobalAverages g ON v.formula = g.formula
WHERE v.amount > g.avg_db_amount
ORDER BY potency_ratio DESC
LIMIT 20;

